//
//  TestBedUIInstallOpenTest.m
//  TestBed-macOSUITests
//
//  Created by Nidhi on 11/3/20.
//  Copyright Â© 2020 Branch. All rights reserved.
//

#import "TestBedUITest.h"
#import "TestBedUIUtils.h"

@interface TestBedUIInstallOpenTest : TestBedUITest

@end

@implementation TestBedUIInstallOpenTest

- (void)setUp {
    [super setUp];
}

- (void)tearDown {
    [super tearDown];
}

- (void)testInstallAndOpen {
    
    __block NSString *identityID;
    __block NSString *deviceFingerprintID;
    
    [TestBedUIUtils deleteSettingsFiles];
    
    XCTWaiterResult result = [self launchAppAndWaitForSessionStart];
    
    if (result != XCTWaiterResultCompleted)
        XCTFail(@"Could not launch App.");
        
    if (self.trackingState == TRACKING_DISABLED) {
        [self enableTracking];
    }
    
    [XCTContext runActivityNamed:@"InstallAPI" block:^(id<XCTActivity> activity){
        if (result == XCTWaiterResultCompleted) {
            
            XCTAssertTrue([[self serverRequestString] containsString:@"/v1/install"]);
            
            NSDictionary *serverResponseDictionary = [ TestBedUIUtils dictionaryFromString:[self serverResponseString]];
            XCTAssertNotNil([serverResponseDictionary valueForKey:@"identity_id"]);
            XCTAssertNotNil([serverResponseDictionary valueForKey:@"device_fingerprint_id"]);
            
            identityID = [serverResponseDictionary objectForKey:@"identity_id"];
            deviceFingerprintID = [serverResponseDictionary objectForKey:@"device_fingerprint_id"];
            
            [activity addAttachment:[XCTAttachment attachmentWithScreenshot:[[XCUIScreen mainScreen] screenshot]]];
            [self terminateTestBed];
            self.appLaunched = FALSE;
        }
        else {
            XCTFail("App Launch / Session Start Failed.");
        }
    }];
    
    result = [self launchAppAndWaitForSessionStart];
    
    if (result != XCTWaiterResultCompleted)
        XCTFail(@"Could not re-launch App.");
    
    [XCTContext runActivityNamed:@"OpenAPI" block:^(id<XCTActivity> activity){
        if (result == XCTWaiterResultCompleted) {
            
            XCTAssertTrue([[self serverRequestString] containsString:@"/v1/open"]);
            
            NSDictionary *serverRequestDictionary = [TestBedUIUtils dictionaryFromString:[self serverRequestString]];
            XCTAssertNotNil([serverRequestDictionary valueForKey:@"identity_id"]);
            XCTAssertEqualObjects([serverRequestDictionary valueForKey:@"identity_id"], identityID);
            
            XCTAssertNotNil([serverRequestDictionary valueForKey:@"device_fingerprint_id"]);
            XCTAssertEqualObjects([serverRequestDictionary valueForKey:@"device_fingerprint_id"], deviceFingerprintID);
          
            XCTAssertTrue([[self serverResponseString] containsString:@"Status 200"]);
        }
        else {
            XCTFail("App Launch / Session Start Failed.");
        }
    }];
        
}

@end
