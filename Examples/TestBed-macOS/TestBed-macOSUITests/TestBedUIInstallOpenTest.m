//
//  TestBedUIInstallOpenTest.m
//  TestBed-macOSUITests
//
//  Created by Nidhi on 11/3/20.
//  Copyright Â© 2020 Branch. All rights reserved.
//

#import "TestBedUITest.h"
#import "TestBedUIUtils.h"

@interface TestBedUIInstallOpenTest : TestBedUITest

@end

@implementation TestBedUIInstallOpenTest

- (void)setUp {
    [super setUp];
}

- (void)tearDown {
    [super tearDown];
}

- (void)testInstallAndOpen {
    
    __block NSString *randomizedBundleToken;
    __block NSString *randomizedDeviceToken;
    
    [TestBedUIUtils deleteSettingsFiles];
    
    if (self.trackingState == TRACKING_DISABLED) {
        [self enableTracking];
    }
    
    XCTWaiterResult result = [self launchAppAndWaitForSessionStart];
    
    [XCTContext runActivityNamed:@"InstallAPI" block:^(id<XCTActivity> activity){
       
        if (result == XCTWaiterResultCompleted) {
            
            XCTAssertTrue([[self serverRequestString] containsString:@"/v1/install"]);
            
            NSDictionary *serverResponseDictionary = [ TestBedUIUtils dictionaryFromString:[self serverResponseString]];
            XCTAssertNotNil([serverResponseDictionary valueForKey:@"randomized_bundle_token"]);
            XCTAssertNotNil([serverResponseDictionary valueForKey:@"randomized_device_token"]);
            
            randomizedBundleToken = [serverResponseDictionary objectForKey:@"randomized_bundle_token"];
            randomizedDeviceToken = [serverResponseDictionary objectForKey:@"randomized_device_token"];
            
            [activity addAttachment:[XCTAttachment attachmentWithScreenshot:[[XCUIScreen mainScreen] screenshot]]];
            [self terminateTestBed];
            self.appLaunched = FALSE;
        }
        else {
            XCTFail("App Launch / Session Start Failed.");
        }
    }];
    
    result = [self launchAppAndWaitForSessionStart];
    
    [XCTContext runActivityNamed:@"OpenAPI" block:^(id<XCTActivity> activity){
        if (result == XCTWaiterResultCompleted) {
            
            XCTAssertTrue([[self serverRequestString] containsString:@"/v1/open"]);
            
            NSDictionary *serverRequestDictionary = [TestBedUIUtils dictionaryFromString:[self serverRequestString]];
            XCTAssertNotNil([serverRequestDictionary valueForKey:@"randomized_bundle_token"]);
            XCTAssertEqualObjects([serverRequestDictionary valueForKey:@"randomized_bundle_token"], randomizedBundleToken);
            
            XCTAssertNotNil([serverRequestDictionary valueForKey:@"randomized_device_token"]);
            XCTAssertEqualObjects([serverRequestDictionary valueForKey:@"randomized_device_token"], randomizedDeviceToken);
          
            XCTAssertTrue([[self serverResponseString] containsString:@"Status 200"]);
        }
        else {
            XCTFail("App Launch / Session Start Failed.");
        }
    }];
        
}

@end
